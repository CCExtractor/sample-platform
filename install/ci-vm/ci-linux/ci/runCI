#!/bin/bash

# This script will run the test suite. It requires no parameters, but needs
# some files to be present on the system. These are:
# - file containing the URL to report to
# - git repository with the code to compile & run

DIR=$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )

if [ ! -f "$DIR/variables" ]; then
    # No variable file defined
    sudo shutdown -h now
fi

# Functions for re-use in various stages of the test progress

# Post status to the server
function postStatus {
    echo "Posting ${1} - ${2} to the server:" >> "${logFile}"
    if [ -n "$3" ] && [ -n "$4" ]; then
        curl -s -A "${userAgent}" --data "type=progress&status=$1&message=$2&current_test=$3&total_tests=$4" -w "\n" "${reportURL}" >> "${logFile}"
    else
        curl -s -A "${userAgent}" --data "type=progress&status=$1&message=$2" -w "\n" "${reportURL}" >> "${logFile}"
    fi
    sleep 5
}

# Send the log file to the server so it can be used
function sendLogFile {
    echo "Sending log to the server:" >> "${logFile}"
    curl -s -A "${userAgent}" --form "type=logupload" --form "file=@${logFile}" -w "\n" "${reportURL}"
    sleep 5
}

# Exit script and post abort status
function haltAndCatchFire {
        sendLogFile
        postStatus "canceled" $1 >> "${logFile}"
        sudo shutdown -h now
}

# Fail when the exit status is not equal to 0
function executeCommand {
        #echo "$@"
        "$@" >> "${logFile}"
        local status=$?
        if [ ${status} -ne 0 ]; then
                haltAndCatchFire "" # No message needed as we post before anyway
        fi
}

# Source variables
. "$DIR/variables"

# Add cargo to path
PATH="/root/.cargo/bin:$PATH"

reportURL=$(curl http://metadata/computeMetadata/v1/instance/attributes/reportURL -H "Metadata-Flavor: Google")
userAgent="CCX/CI_BOT"
logFile="${reportFolder}/log.html"

postStatus "preparation" "Loaded variables, created log file and checking for CCExtractor build artifact"

if [ -e "${dstDir}/ccextractor" ]; then
        cp $dstDir/* ./
        chmod 700 ccextractor
        chmod +x ${tester}
        # Log binary version for verification (commit SHA will be visible in output)
        echo "=== CCExtractor Binary Version ===" >> "${logFile}"
        ./ccextractor --version >> "${logFile}" 2>&1
        echo "=== End Version Info ===" >> "${logFile}"
        
        # Count total tests from XML file
        totalTests=0
        if [ -f "${testFile}" ]; then
            # Count <test> elements in the XML file
            totalTests=$(grep -c "<test>" "${testFile}" 2>/dev/null || echo "0")
            echo "Total tests to run: ${totalTests}" >> "${logFile}"
        fi
        
        # Post testing status with total count
        if [ ${totalTests} -gt 0 ]; then
            postStatus "testing" "Running tests" "0" "${totalTests}"
        else
            postStatus "testing" "Running tests"
        fi
        
        executeCommand cd ${suiteDstDir}
        executeCommand ${tester} --debug --entries "${testFile}" --executable "ccextractor" --tempfolder "${tempFolder}" --timeout 600 --reportfolder "${reportFolder}" --resultfolder "${resultFolder}" --samplefolder "${sampleFolder}" --method Server --url "${reportURL}"
        sendLogFile
        postStatus "completed" "Ran all tests"

        sudo shutdown -h now
else
        haltAndCatchFire "artifact"
fi
