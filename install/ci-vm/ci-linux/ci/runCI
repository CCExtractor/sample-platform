#!/bin/bash

# This script will run the test suite. It requires no parameters, but needs
# some files to be present on the system. These are:
# - file containing the URL to report to
# - git repository with the code to compile & run

DIR=$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )

if [ ! -f "$DIR/variables" ]; then
    # No variable file defined
    sudo shutdown -h now
fi

# Functions for re-use in various stages of the test progress

# Post status to the server with retry logic
function postStatus {
    local status="$1"
    local message="$2"
    local max_retries=3
    local retry_delay=5
    local attempt=1

    echo "Posting ${status} - ${message} to the server:" >> "${logFile}"

    while [ $attempt -le $max_retries ]; do
        local http_code
        http_code=$(curl -s -A "${userAgent}" --data "type=progress&status=${status}&message=${message}" \
            -w "%{http_code}" -o /tmp/curl_response.txt "${reportURL}" 2>/dev/null)
        local curl_exit=$?

        if [ $curl_exit -eq 0 ] && [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]; then
            echo "Status posted successfully (HTTP ${http_code})" >> "${logFile}"
            cat /tmp/curl_response.txt >> "${logFile}" 2>/dev/null
            echo "" >> "${logFile}"
            sleep 5
            return 0
        fi

        echo "Attempt ${attempt}/${max_retries} failed (curl exit: ${curl_exit}, HTTP: ${http_code})" >> "${logFile}"
        attempt=$((attempt + 1))

        if [ $attempt -le $max_retries ]; then
            echo "Retrying in ${retry_delay} seconds..." >> "${logFile}"
            sleep $retry_delay
            retry_delay=$((retry_delay * 2))
        fi
    done

    echo "ERROR: Failed to post status after ${max_retries} attempts" >> "${logFile}"
    return 1
}

# Send the log file to the server with retry logic
function sendLogFile {
    local max_retries=3
    local retry_delay=5
    local attempt=1

    echo "Sending log to the server:" >> "${logFile}"

    while [ $attempt -le $max_retries ]; do
        local http_code
        http_code=$(curl -s -A "${userAgent}" --form "type=logupload" --form "file=@${logFile}" \
            -w "%{http_code}" -o /tmp/curl_log_response.txt "${reportURL}" 2>/dev/null)
        local curl_exit=$?

        if [ $curl_exit -eq 0 ] && [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]; then
            echo "Log uploaded successfully (HTTP ${http_code})" >> "${logFile}"
            sleep 5
            return 0
        fi

        echo "Log upload attempt ${attempt}/${max_retries} failed (curl exit: ${curl_exit}, HTTP: ${http_code})" >> "${logFile}"
        attempt=$((attempt + 1))

        if [ $attempt -le $max_retries ]; then
            echo "Retrying log upload in ${retry_delay} seconds..." >> "${logFile}"
            sleep $retry_delay
            retry_delay=$((retry_delay * 2))
        fi
    done

    echo "ERROR: Failed to upload log after ${max_retries} attempts" >> "${logFile}"
    return 1
}

# Exit script and post abort status
function haltAndCatchFire {
        sendLogFile
        postStatus "canceled" $1 >> "${logFile}"
        sudo shutdown -h now
}

# Fail when the exit status is not equal to 0
function executeCommand {
        #echo "$@"
        "$@" >> "${logFile}"
        local status=$?
        if [ ${status} -ne 0 ]; then
                haltAndCatchFire "" # No message needed as we post before anyway
        fi
}

# Source variables
. "$DIR/variables"

# Add cargo to path
PATH="/root/.cargo/bin:$PATH"

reportURL=$(curl http://metadata/computeMetadata/v1/instance/attributes/reportURL -H "Metadata-Flavor: Google")
userAgent="CCX/CI_BOT"
logFile="${reportFolder}/log.html"

postStatus "preparation" "Loaded variables, created log file and checking for CCExtractor build artifact"

if [ -e "${dstDir}/ccextractor" ]; then
        cp $dstDir/* ./
        chmod 700 ccextractor
        chmod +x ${tester}
        # Log binary version for verification (commit SHA will be visible in output)
        echo "=== CCExtractor Binary Version ===" >> "${logFile}"
        ./ccextractor --version >> "${logFile}" 2>&1
        echo "=== End Version Info ===" >> "${logFile}"
        postStatus "testing" "Running tests"
        executeCommand cd ${suiteDstDir}
        executeCommand ${tester} --debug --entries "${testFile}" --executable "ccextractor" --tempfolder "${tempFolder}" --timeout 600 --reportfolder "${reportFolder}" --resultfolder "${resultFolder}" --samplefolder "${sampleFolder}" --method Server --url "${reportURL}"
        sendLogFile
        postStatus "completed" "Ran all tests"

        sudo shutdown -h now
else
        haltAndCatchFire "artifact"
fi
